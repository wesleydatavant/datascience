
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Thompson Sampling - Data Science</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../extra.css">
    
      <link rel="stylesheet" href="../styles.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-114664473-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#univariate-thompson-sampling-with-pokemon" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Data Science" class="md-header__button md-logo" aria-label="Data Science" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Data Science
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Thompson Sampling
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Data Science" class="md-nav__button md-logo" aria-label="Data Science" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Data Science
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../vectorized_distances/" class="md-nav__link">
        Vectorized Distance Calculations
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Thompson Sampling
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Thompson Sampling
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-overview" class="md-nav__link">
    Problem Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beta-binomial-model" class="md-nav__link">
    Beta Binomial Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beta-model" class="md-nav__link">
    Beta Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-simulation-one-region-three-pokemon" class="md-nav__link">
    First Simulation: One Region, Three Pokemon
  </a>
  
    <nav class="md-nav" aria-label="First Simulation: One Region, Three Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ts-approach" class="md-nav__link">
    TS Approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greedy-approach" class="md-nav__link">
    Greedy Approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#second-simulation-one-region-ten-pokemon" class="md-nav__link">
    Second Simulation: One Region, Ten Pokemon
  </a>
  
    <nav class="md-nav" aria-label="Second Simulation: One Region, Ten Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ts-approach_1" class="md-nav__link">
    TS Approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greedy-approach_1" class="md-nav__link">
    Greedy Approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#third-simulation-four-regions-three-pokemon" class="md-nav__link">
    Third Simulation: Four Regions, Three Pokemon
  </a>
  
    <nav class="md-nav" aria-label="Third Simulation: Four Regions, Three Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#distancecontext" class="md-nav__link">
    DistanceContext
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ground-truth" class="md-nav__link">
    Ground Truth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-one-the-effect-of-context" class="md-nav__link">
    Demonstration One: The Effect of Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-two-taking-weighted-samples" class="md-nav__link">
    Demonstration Two: Taking Weighted Samples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-three-updating-parameters" class="md-nav__link">
    Demonstration Three: Updating Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiarmedbandit" class="md-nav__link">
    MultiArmedBandit
  </a>
  
    <nav class="md-nav" aria-label="MultiArmedBandit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pewter-city-sims" class="md-nav__link">
    Pewter City Sims
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confidence-intervals" class="md-nav__link">
    Confidence Intervals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#imports" class="md-nav__link">
    Imports
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#problem-overview" class="md-nav__link">
    Problem Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav" aria-label="Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beta-binomial-model" class="md-nav__link">
    Beta Binomial Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beta-model" class="md-nav__link">
    Beta Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#first-simulation-one-region-three-pokemon" class="md-nav__link">
    First Simulation: One Region, Three Pokemon
  </a>
  
    <nav class="md-nav" aria-label="First Simulation: One Region, Three Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ts-approach" class="md-nav__link">
    TS Approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greedy-approach" class="md-nav__link">
    Greedy Approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#second-simulation-one-region-ten-pokemon" class="md-nav__link">
    Second Simulation: One Region, Ten Pokemon
  </a>
  
    <nav class="md-nav" aria-label="Second Simulation: One Region, Ten Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ts-approach_1" class="md-nav__link">
    TS Approach
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#greedy-approach_1" class="md-nav__link">
    Greedy Approach
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#third-simulation-four-regions-three-pokemon" class="md-nav__link">
    Third Simulation: Four Regions, Three Pokemon
  </a>
  
    <nav class="md-nav" aria-label="Third Simulation: Four Regions, Three Pokemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#distancecontext" class="md-nav__link">
    DistanceContext
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ground-truth" class="md-nav__link">
    Ground Truth
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-one-the-effect-of-context" class="md-nav__link">
    Demonstration One: The Effect of Context
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-two-taking-weighted-samples" class="md-nav__link">
    Demonstration Two: Taking Weighted Samples
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demonstration-three-updating-parameters" class="md-nav__link">
    Demonstration Three: Updating Parameters
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiarmedbandit" class="md-nav__link">
    MultiArmedBandit
  </a>
  
    <nav class="md-nav" aria-label="MultiArmedBandit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pewter-city-sims" class="md-nav__link">
    Pewter City Sims
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#confidence-intervals" class="md-nav__link">
    Confidence Intervals
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<p><a href="https://colab.research.google.com/github/wesleydatavant/datascience/blob/main/notebooks/thompson_sampling_univariate.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a></p>
<h1 id="univariate-thompson-sampling-with-pokemon">Univariate Thompson Sampling, with Pokemon!<a class="headerlink" href="#univariate-thompson-sampling-with-pokemon" title="Permanent link">&para;</a></h1>
<p><br></p>
<hr />
<p><br></p>
<p>In this project notebook we'll be exploring the multi armed bandit problem with thompson sampling.</p>
<p>Read more <a href="https://arxiv.org/pdf/1707.02038.pdf">here</a></p>
<p><br></p>
<hr />
<h2 id="imports">Imports<a class="headerlink" href="#imports" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cdist</span>
<span class="kn">from</span> <span class="nn">haversine</span> <span class="kn">import</span> <span class="n">haversine</span><span class="p">,</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">betabinom</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">binom</span><span class="p">,</span> <span class="n">norm</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
</code></pre></div>

<h2 id="problem-overview">Problem Overview<a class="headerlink" href="#problem-overview" title="Permanent link">&para;</a></h2>
<p>Youâ€™re hunting for Pokemon in some forested area outside of Pewter City, divided into four regions. You know that in each region, the probability of finding one of either Charmander, Bulbasaur or Pikachu willl vary. Given a region, which pokemon are we most likely to find?</p>
<p><center>
<img src="https://raw.githubusercontent.com/wesleydatavant/datascience/main/notebooks/static/Routing_%20Model%20Development%208.19.22.jpeg" width=600px></img>
</center></p>
<p>Intuitively, we would expect distances between regions to have some relationship with the similarity in probability distributions.</p>
<p>For the purpose of demonstrating the algorithm, imagine that you are going to spend many iterations searching through each region, and every time you search a region you can only check for one of the three pokemon. </p>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>Before we dive into this problem we've specified, let's talk about our building blocks. The first building block will be the beta distribution. A beta distribution describes a probability of probabilities. In short, it estimates the expected reward from a binomial distribution. Which is perfect for us, because when we search for a Pokemon we either find it (success, 1) or don't find it (failure, 0). The outcome of many searches allows us to parmaterize a beta distribution for every pokemon for every region. The number of times we successfully find a pokemon is taken as the value of alpha for the beta distribution, its first parameter; and the number of times we unsuccessfully search for a pokemon in a region is taken as the value of beta for the beta distribution, its second parameter.</p>
<h3 id="beta-binomial-model">Beta Binomial Model<a class="headerlink" href="#beta-binomial-model" title="Permanent link">&para;</a></h3>
<p>Below is an example of building a binomial distribution to sample from, given a historical record of how many succcesses (alpha, or pokemon found) and failures (beta, or pokemon not found) in the region:</p>
<div class="codehilite"><pre><span></span><code><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># number of outcomes + 1</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">12</span> <span class="c1"># number of succcess</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># number of fail</span>

<span class="c1"># alpha and beta are used to estimate the distribution</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">betabinom</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span>
                <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># we can then sample from this parameterized beta-binomial model</span>
<span class="n">dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>array([1, 0, 1, 1, 1, 0, 0, 0, 0, 0])
</code></pre></div>

<p>We can also take this parameterized binomial distribution and plot the probability mass function:</p>
<div class="codehilite"><pre><span></span><code><span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">betabinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">betabinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">betabinom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c1"># ax.set_ylim(0,1)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x17225f8b0&gt;]
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_9_1.png" /></p>
<h3 id="beta-model">Beta Model<a class="headerlink" href="#beta-model" title="Permanent link">&para;</a></h3>
<p>When we start talking about Thompson Sampling, we will not be sampling from the binomial distributions themselves. Rather, we will sample from the <em>beta</em> distribution that represents what would be a reasonable expectation of average success rate for finding each of the pokemon. The beta distribution for three pokemon is represented below. In the following example we would expect to prioritize sampling Bulbasaur but also expect to find Pikachu in the area.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># one region outside of Pewter City</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">601</span><span class="p">,</span> <span class="mi">401</span><span class="p">],</span> <span class="c1"># pokemon A (Bublasaur)</span>
                  <span class="p">[</span><span class="mi">401</span><span class="p">,</span> <span class="mi">601</span><span class="p">],</span> <span class="c1"># pokemon B (Charmander)</span>
                  <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">]])</span> <span class="c1"># pokemon C (Pikachu)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Bulbasaur&quot;</span><span class="p">,</span> <span class="s2">&quot;Charmander&quot;</span><span class="p">,</span> <span class="s2">&quot;Pikachu&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pokemon</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Expected Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Estimated Rewards for Pokemon in Region A outside of Pewter City&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0.5, 1.0, &#39;Estimated Rewards for Pokemon in Region A outside of Pewter City&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_11_1.png" /></p>
<h2 id="first-simulation-one-region-three-pokemon">First Simulation: One Region, Three Pokemon<a class="headerlink" href="#first-simulation-one-region-three-pokemon" title="Permanent link">&para;</a></h2>
<p>Before we tackle the four region problem, let's consider just a single region and how the Thompson Sampling (TS) algorithm would work in this context.</p>
<p>For every step in the TS algorithm:</p>
<ol>
<li>Estimate univariate beta distributions (one for each Pokemon)</li>
<li>Sample from every beta distribution and select the pokemon with the maximum reward</li>
<li>Search for the selected Pokemon, update it's beta parameters</li>
</ol>
<p>
<script type="math/tex; mode=display">
  (\alpha_k, \beta_k) = \left \{
  \begin{aligned}
    &(\alpha_k, \beta_k) + (r_t, 1-r_t), && \text{if}\ x_t = k \\
    &(\alpha_k, \beta_k), && \text{otherwise}
  \end{aligned} \right.
</script>
</p>
<p>where \(r_t\) refers to the outcome of the action taken this time step and is 1 if the action was successful and 0 otherwise; \(k\) are the available Pokemon (sometimes referred to as actions); and \(x_t\) is the Pokemon (action) selected at time step, \(t\).</p>
<p>Before moving forward, let's create a "ground truth" that we will call <code>true_charts</code> of where the Pokemon will be at each time step (each time we search the region):</p>
<div class="codehilite"><pre><span></span><code><span class="n">num_searches</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">601</span><span class="p">,</span> <span class="mi">401</span><span class="p">],</span> <span class="c1"># pokemon A (Bublasaur)</span>
                  <span class="p">[</span><span class="mi">401</span><span class="p">,</span> <span class="mi">601</span><span class="p">],</span> <span class="c1"># pokemon B (Charmander)</span>
                  <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">30</span><span class="p">]])</span> <span class="c1"># pokemon C (Pikachu)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="n">betabinom</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_searches</span><span class="p">):</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">exp</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
    <span class="n">true_charts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="p">)</span>

<span class="n">sums</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span>
<span class="n">sums</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sums</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">sums</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">pokemon</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>[Text(0, 0, &#39;Bulbasaur&#39;), Text(1, 0, &#39;Charmander&#39;), Text(2, 0, &#39;Pikachu&#39;)]
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_14_1.png" /></p>
<h3 id="ts-approach">TS Approach<a class="headerlink" href="#ts-approach" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># params represents the success (alpha) and failure (beta)</span>
<span class="c1"># of each pokemon based on historical performances</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># pokemon A</span>
                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># pokemon B</span>
                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="c1"># pokemon C</span>

<span class="c1"># pokemon_names = [&quot;Pokemon 1&quot;, &quot;Pokemon 2&quot;, &quot;Pokemon 3&quot;]</span>

<span class="c1"># we are simulating 10,000 record searches and assuming</span>
<span class="c1"># the record is either in pokemon A, B, C or none of them</span>
<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_searches</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># note that we sample from beta and not binomial - we are sampling</span>
        <span class="c1"># a reasonable expectation of success, not the outcome (0, 1) were</span>
        <span class="c1"># the pokemon to be selected</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sample</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># did not beat best</span>

    <span class="c1"># update alpha/beta for selected</span>
    <span class="k">if</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_idx</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successes: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failures: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>successes: 65.4%
failures: 34.6%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0, 0.5, &#39;Probability Density&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_18_1.png" /></p>
<h3 id="greedy-approach">Greedy Approach<a class="headerlink" href="#greedy-approach" title="Permanent link">&para;</a></h3>
<p>We can also compare this with a greedy algorithm, where we always select the action with the highest expected reward (i.e. we do not sample)</p>
<div class="codehilite"><pre><span></span><code><span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># pokemon A</span>
                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1"># pokemon B</span>
                  <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> <span class="c1"># pokemon C</span>

<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_requests</span><span class="p">):</span>

    <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_idx</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successes: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failures: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>successes: 65.6%
failures: 34.4%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0, 0.5, &#39;Probability Density&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_22_1.png" /></p>
<h2 id="second-simulation-one-region-ten-pokemon">Second Simulation: One Region, Ten Pokemon<a class="headerlink" href="#second-simulation-one-region-ten-pokemon" title="Permanent link">&para;</a></h2>
<p>Let's now see how the algorithm would work expanding to 10 possible pokemon in the given region</p>
<div class="codehilite"><pre><span></span><code><span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pokemon_expectations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)</span>

<span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">pokemon</span> <span class="ow">in</span> <span class="n">pokemon_expectations</span><span class="p">:</span>
    <span class="n">pokemon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">true_charts</span><span class="p">,</span> <span class="n">pokemon</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">10000</span><span class="p">)))</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="n">true_charts</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">true_charts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">rank_order_pokemons</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
<span class="n">pokemon_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Pokemon </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rank_order_pokemons</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True Pokemon in Area, N=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">pokemon_names</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Record Count&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_25_0.png" /></p>
<h3 id="ts-approach_1">TS Approach<a class="headerlink" href="#ts-approach_1" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># params represents the success (alpha) and failure (beta)</span>
<span class="c1"># of each pokemon based on historical performances</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">pokemon_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Pokemon </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)]</span>

<span class="c1"># we are simulating 10,000 record searches and assuming</span>
<span class="c1"># the record is either in pokemon A, B, C or none of them</span>
<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_requests</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>

        <span class="c1"># note that we sample from beta and not binomial - we are sampling</span>
        <span class="c1"># a reasonable expectation of success, not the outcome (0, 1) were</span>
        <span class="c1"># the pokemon to be selected</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sample</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">sample</span>
            <span class="n">best_idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1"># did not beat best</span>

    <span class="c1"># update alpha/beta for selected</span>
    <span class="k">if</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_idx</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successes: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failures: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>successes: 17.1%
failures: 82.9%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pokemon_names</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0, 0.5, &#39;Probability Density&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_29_1.png" /></p>
<h3 id="greedy-approach_1">Greedy Approach<a class="headerlink" href="#greedy-approach_1" title="Permanent link">&para;</a></h3>
<p>This will be the last time we compare with the greedy solution.</p>
<div class="codehilite"><pre><span></span><code><span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="n">pokemon_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Pokemon </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)]</span>

<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_requests</span><span class="p">):</span>

    <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="o">==</span> <span class="n">best_idx</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">best_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successes: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failures: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">params</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>successes: 16.2%
failures: 83.8%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pokemon_names</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span>
                <span class="n">beta</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Mean Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability Density&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0, 0.5, &#39;Probability Density&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_33_1.png" /></p>
<h2 id="third-simulation-four-regions-three-pokemon">Third Simulation: Four Regions, Three Pokemon<a class="headerlink" href="#third-simulation-four-regions-three-pokemon" title="Permanent link">&para;</a></h2>
<p>In this third simulation, we will tackle the original problem we scoped in the beginning:</p>
<blockquote>
<p>Youâ€™re hunting for Pokemon in some forested area outside of Pewter City, divided into four regions. You know that in each region, the probability of finding one of either Charmander, Bulbasaur or Pikachu willl vary. If we are looking for one Pokemon in particular, let's say Charmander (we love Charmander), which region should you head to, to maximize the probability of finding Charmander?</p>
</blockquote>
<p>In this problem, we want to take into consideration the probabilities of surrounding regions. </p>
<blockquote>
<p>For a practical example of prior selection, let us revisit the banner
ad placement problem introduced in Example 1.1. There are K banner
ads for a single product, with unknown click-through probabilities
(Î¸1, . . . , Î¸K). Given a prior, TS can learn to select the most successful
ad. We could use a uniform or, equivalently, a beta(1, 1) distribution over
each Î¸k. However, if some values of Î¸k are more likely than others, using a
uniform prior sacrifices performance. In particular, this prior represents
no understanding of the context, ignoring any useful knowledge from
past experience. Taking knowledge into account reduces what must be
learned and therefore reduces the time it takes for TS to identify the
most effective ads.</p>
</blockquote>
<p><a href="https://arxiv.org/pdf/1707.02038.pdfhttps://arxiv.org/pdf/1707.02038.pdf">TS paper</a></p>
<h3 id="distancecontext">DistanceContext<a class="headerlink" href="#distancecontext" title="Permanent link">&para;</a></h3>
<p>We will leverage the known distances between regions </p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">haversine_vectorized</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vectorized haversine formual will work with arrays of long/lat coordinates</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array, shape=(n_samples_1, 2)</span>
<span class="sd">      the first list of coordinates (degrees)</span>
<span class="sd">    y : array: shape=(n_samples_2, 2)</span>
<span class="sd">      the second list of coordinates (degress)</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    d : array, shape=(n_samples_1, n_samples_2)</span>
<span class="sd">      the distance between corrdinates (km)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">EARTH_RADIUS</span> <span class="o">=</span> <span class="mf">3958.76</span>

    <span class="c1"># convert all latitudes/longitudes from decimal degrees to radians</span>
    <span class="n">x_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="c1"># unpack latitude/longitude</span>
    <span class="n">x_lat</span><span class="p">,</span> <span class="n">x_lng</span> <span class="o">=</span> <span class="n">x_rad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_rad</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">y_lat</span><span class="p">,</span> <span class="n">y_lng</span> <span class="o">=</span> <span class="n">y_rad</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_rad</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="c1"># broadcast, can also use np.expand_dims</span>
    <span class="n">x_lat</span> <span class="o">=</span> <span class="n">x_lat</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">x_lng</span> <span class="o">=</span> <span class="n">x_lng</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">y_lat</span> <span class="o">=</span> <span class="n">y_lat</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">y_lng</span> <span class="o">=</span> <span class="n">y_lng</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># calculate haversine</span>
    <span class="n">d_lat</span> <span class="o">=</span> <span class="n">y_lat</span> <span class="o">-</span> <span class="n">x_lat</span>
    <span class="n">d_lng</span> <span class="o">=</span> <span class="n">y_lng</span> <span class="o">-</span> <span class="n">x_lng</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d_lat</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
         <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">y_lat</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">d_lng</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">EARTH_RADIUS</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_city_center</span><span class="p">(</span><span class="n">city</span><span class="o">=</span><span class="s1">&#39;Pewter&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns coordinates of the city center</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">city_json</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;city&quot;</span><span class="p">:{</span><span class="s2">&quot;4&quot;</span><span class="p">:</span><span class="s2">&quot;Pewter&quot;</span><span class="p">,</span><span class="s2">&quot;5&quot;</span><span class="p">:</span><span class="s2">&quot;Cerulean&quot;</span><span class="p">,</span><span class="s2">&quot;33&quot;</span><span class="p">:</span><span class="s2">&quot;Vermilion&quot;</span><span class="p">,</span><span class="s2">&quot;55&quot;</span><span class="p">:</span><span class="s2">&quot;Saffron&quot;</span><span class="p">},</span>
               <span class="s2">&quot;lat&quot;</span><span class="p">:{</span><span class="s2">&quot;4&quot;</span><span class="p">:</span><span class="mf">32.7935</span><span class="p">,</span><span class="s2">&quot;5&quot;</span><span class="p">:</span><span class="mf">29.786</span><span class="p">,</span><span class="s2">&quot;33&quot;</span><span class="p">:</span><span class="mf">30.3005</span><span class="p">,</span><span class="s2">&quot;55&quot;</span><span class="p">:</span><span class="mf">32.7817</span><span class="p">},</span>
               <span class="s2">&quot;lng&quot;</span><span class="p">:{</span><span class="s2">&quot;4&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">96.7667</span><span class="p">,</span><span class="s2">&quot;5&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">95.3885</span><span class="p">,</span><span class="s2">&quot;33&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">97.7522</span><span class="p">,</span><span class="s2">&quot;55&quot;</span><span class="p">:</span><span class="o">-</span><span class="mf">97.3474</span><span class="p">}}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">city_json</span><span class="p">)</span>
    <span class="n">lat_lng</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;city&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lng&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="k">return</span> <span class="n">lat_lng</span>

<span class="k">def</span> <span class="nf">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns the maximum radius in degrees to obtain a given maximum distance from city center in km</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lat_lng_max</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">radius_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
            <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">[</span><span class="kc">None</span><span class="p">,:],</span> 
                                <span class="p">(</span><span class="n">lat_lng</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lat_lng_max</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> 
            <span class="n">km_max</span><span class="p">,</span> 
            <span class="n">rtol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lat_lng_max</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)[</span><span class="n">radius_idx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">lat_lng_max</span>

<span class="k">def</span> <span class="nf">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    returns an array of coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seed</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">lat_lng_max</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_targets</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_targets</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">lat_lng</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">site_lng_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span><span class="n">y</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">site_lng_lat</span>
</code></pre></div>

<p>First we compute the distance matrix</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># SIM SETUP</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">lat_lng</span> <span class="o">=</span> <span class="n">get_city_center</span><span class="p">(</span><span class="s1">&#39;Pewter&#39;</span><span class="p">)</span>
<span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
<span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

<span class="n">ground_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pokemon_region_matrix</span><span class="o">/</span><span class="n">pokemon_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">region_region_matrix</span><span class="o">/</span><span class="n">region_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
</code></pre></div>

<p>We have region to region distances</p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">region_region_matrix</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;region center&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region center&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(24.0, 0.5, &#39;region center&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_40_1.png" /></p>
<p>As well as pokemon density center to region distances</p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;pokemon density center&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region center&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(24.0, 0.5, &#39;region center&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_42_1.png" /></p>
<p>Create an inverse mapping from 0 to 1 based on each of these matrices</p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">ground_coef_matrix</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;pokemon&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(24.0, 0.5, &#39;region&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_44_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(24.0, 0.5, &#39;region&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_45_1.png" /></p>
<h3 id="ground-truth">Ground Truth<a class="headerlink" href="#ground-truth" title="Permanent link">&para;</a></h3>
<p>A little more involved than before since we are dealing with spatial relationships and many regions</p>
<p><code>spatial_pokemon_expectations</code> will contain the expected success rate for each pokemon according to each local region</p>
<div class="codehilite"><pre><span></span><code><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">100000</span> <span class="c1"># the number of searches per region</span>
<span class="n">pokemon_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Pokemon </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)]</span>
<span class="n">region_name</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Region </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regions</span><span class="p">)]</span>

<span class="n">pokemon_expectations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)</span> <span class="c1"># an overall expected performance for each pokemon</span>
<span class="n">spatial_pokemon_expectations</span> <span class="o">=</span> <span class="n">ground_coef_matrix</span> <span class="o">*</span> <span class="n">pokemon_expectations</span>
<span class="n">dists</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">spatial_pokemon_expectations</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">num_searches</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">))</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">spatial_pokemon_expectations</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;pokemon region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mean Reward for Pokemons w.r.t Region&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0.5, 1.0, &#39;Mean Reward for Pokemons w.r.t Region&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_47_1.png" /></p>
<p>Once we have the ground truth, we must also compute the <code>best possible</code> expected performance for each region, if we were to only choose the dominant pokemon for each one</p>
<div class="codehilite"><pre><span></span><code><span class="n">max_exp_greedy</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Maximum Expectation for Each Region&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regions</span><span class="p">):</span>
    <span class="n">pop_pokemon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">true_charts</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_charts</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pop_pokemon</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">true_charts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_exp_greedy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region_name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">exp</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Pokemon </span><span class="si">{</span><span class="n">pop_pokemon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Maximum Expectation for Each Region

Region 0: 0.55, Pokemon 0
Region 1: 0.40, Pokemon 0
Region 2: 0.43, Pokemon 1
Region 3: 0.38, Pokemon 0
</code></pre></div>

<h3 id="demonstration-one-the-effect-of-context">Demonstration One: The Effect of Context<a class="headerlink" href="#demonstration-one-the-effect-of-context" title="Permanent link">&para;</a></h3>
<p>In this simple demonstration we're going to showcase how weighting might work. </p>
<p>Let's imagine the region we've selected is at region associated with row <code>0</code>. How does our selection change when we receive varrying information from other regions? See the implementation below:</p>
<div class="codehilite"><pre><span></span><code><span class="n">high_weight_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">low_weight_region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="n">target</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">region</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;We will run two tests:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">test_regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">high_weight_region</span><span class="p">,</span> <span class="n">low_weight_region</span><span class="p">]</span>
<span class="n">test_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;high&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">]</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">test</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">test_regions</span><span class="p">,</span> <span class="n">test_names</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">params</span><span class="p">[</span><span class="n">test</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">params</span><span class="p">[</span><span class="n">test</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10000</span>

    <span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="c1">### SIMULATE SINGLE PATIENT BASED FLOW REQUEST ###</span>
        <span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">region</span><span class="p">,</span> <span class="n">target</span><span class="p">]</span> <span class="c1"># the region and real pokemon ID associated with the request (irl pokemon ID unknown)</span>
        <span class="n">request_region</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">request_pokemon</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="p">[</span><span class="n">request_region</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># sample from entire parameter matrix for surrounding area</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># take the argmax of the weighted average for each pokemon</span>
        <span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">. We set a heavy bias for &#39;Pokemon </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2">&#39; at &#39;Region </span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s2">&#39; where the contextual information is weighted very </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pokemon </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> Bias from Region </span><span class="si">{</span><span class="n">test</span><span class="si">}</span><span class="s2"> Effect on Region </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>We will run two tests:

1. We set a heavy bias for &#39;Pokemon 1&#39; at &#39;Region 1&#39; where the contextual information is weighted very high
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_51_1.png" /></p>
<div class="codehilite"><pre><span></span><code>2. We set a heavy bias for &#39;Pokemon 1&#39; at &#39;Region 2&#39; where the contextual information is weighted very low
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_51_3.png" /></p>
<p>As we can see, the pokemon 1 bias counts for a lot more when it is coming from a region with a high coefficient weight.</p>
<h3 id="demonstration-two-taking-weighted-samples">Demonstration Two: Taking Weighted Samples<a class="headerlink" href="#demonstration-two-taking-weighted-samples" title="Permanent link">&para;</a></h3>
<p>Recall for every step in the TS algorithm:</p>
<ol>
<li>Estimate univariate beta distributions (one for each Pokemon)</li>
<li>Sample from every beta distribution and select the pokemon with the maximum reward</li>
<li>Search for the selected Pokemon, update \(\theta\) and \(X\)</li>
</ol>
<p>
<script type="math/tex; mode=display">
  \theta = \left \{
  \begin{aligned}
    &(\alpha_{k,p}, \beta_{k,p}) + (r_t, 1-r_t), && \text{if}\ x_t = k, y_t = p \\
    &(\alpha_{k,p}, \beta_{k,p}), && \text{otherwise}
  \end{aligned} \right.
</script>
<br><br>
<script type="math/tex; mode=display">
  X = \left \{
  \begin{aligned}
    &X+(r_t-X)\space\eta, && \text{if}\ \theta_{max}=(\theta^T \cdot X)_{max} \\
    &X, && \text{otherwise}
  \end{aligned} \right.
</script>
</p>
<p>where </p>
<p>\(X\) : the context coefficient matrix <br>
\(\theta\) : estimated success probabilities <br>
\(t\): current time step <br>
\(p\): available regions <br>
\(k\): available targets/actions (pokemon 0, 1, 2) <br>
\(x_t\): the target selected/action taken <br>
\(y_t\): the current region <br>
\(r_t\): the reward of selected target (0 or 1) <br>
\(\alpha\) : alpha parameter of the beta distribution <br>
\(\beta\) : beta parameter of the beta distribution <br>
\(\eta\) : context learning rate <br></p>
<div class="codehilite"><pre><span></span><code><span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
<span class="c1"># SIM SETUP</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">lat_lng</span> <span class="o">=</span> <span class="n">get_city_center</span><span class="p">(</span><span class="s1">&#39;Pewter&#39;</span><span class="p">)</span>
<span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
<span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

<span class="n">ground_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pokemon_region_matrix</span><span class="o">/</span><span class="n">pokemon_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">region_region_matrix</span><span class="o">/</span><span class="n">region_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

<span class="n">pokemon_expectations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)</span> <span class="c1"># an overall expected performance for each pokemon</span>
<span class="n">spatial_pokemon_expectations</span> <span class="o">=</span> <span class="n">ground_coef_matrix</span> <span class="o">*</span> <span class="n">pokemon_expectations</span>
<span class="n">dists</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">spatial_pokemon_expectations</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">num_searches</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">))</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="c1"># params represents the success (alpha) and failure (beta)</span>
<span class="c1"># of finding each pokemon based on historical performances</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">regret</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sim_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_searches</span><span class="p">):</span>

    <span class="c1">### SIMULATE SINGLE PATIENT BASED FLOW REQUEST ###</span>
    <span class="n">region_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_regions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pokemon_id</span> <span class="o">=</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">sim_step</span><span class="p">,</span> <span class="n">region_id</span><span class="p">]</span>

    <span class="c1"># load coefficients for the received region ID</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># sample from entire parameter matrix for surrounding area</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculate the mean of the distributions to determine regret</span>
    <span class="n">current_dist</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">max_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="c1"># take the argmax of the weighted average for each pokemon</span>
    <span class="n">selected_pokemon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">selected_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> 

    <span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_pokemon</span><span class="p">)</span>
    <span class="n">regret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_exp</span> <span class="o">-</span> <span class="n">max_exp</span><span class="p">)</span>

    <span class="c1">### TRACK SUCCESS/FAIL UPDATE PARAMS ###</span>
    <span class="k">if</span> <span class="n">pokemon_id</span> <span class="o">==</span> <span class="n">selected_pokemon</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_pokemon</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_pokemon</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The sample shape is determined by (regions x pokemon): </span><span class="si">{</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="si">}</span><span class="se">\n</span><span class="s2">and reflects &quot;</span>\
     <span class="s2">&quot;the expected value for every pokemon for every region:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$ (expected rewards) at time step, &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">sim_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The contextual TS algorithm will sum these samples along axis 0 (regions) </span><span class="se">\n</span><span class="s2">weighted by the &quot;</span>\
      <span class="s2">&quot;distance to the selected region:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X$ (context coefficients) at time step, &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">sim_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Every simulation round, a region is selected from which our algorithm receives a search request.&quot;</span><span class="p">)</span>
<span class="n">region_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_regions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The selected region for this round is: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;and so the coefficients will reflect that we weight region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2"> by 1 and all other&quot;</span>\
     <span class="sa">f</span><span class="s2">&quot; regions between 0-1 </span><span class="se">\n</span><span class="s2">according to their distance to region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;so the final expected value matrix is:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Weighted expectations at time step, &quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">sim_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;and pokemon </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">))</span><span class="si">}</span><span class="s2"> is selected this round&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>The sample shape is determined by (regions x pokemon): (4, 3)
and reflects the expected value for every pokemon for every region:
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_54_1.png" /></p>
<div class="codehilite"><pre><span></span><code>The contextual TS algorithm will sum these samples along axis 0 (regions) 
weighted by the distance to the selected region:
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_54_3.png" /></p>
<div class="codehilite"><pre><span></span><code>Every simulation round, a region is selected from which our algorithm receives a search request.
The selected region for this round is: 2
and so the coefficients will reflect that we weight region 2 by 1 and all other regions between 0-1 
according to their distance to region 2:

[0.05614041 0.58917249 1.         0.        ]

so the final expected value matrix is:

[0.20854324 0.64361233 0.84080672]
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_54_5.png" /></p>
<div class="codehilite"><pre><span></span><code>and pokemon 2 is selected this round
</code></pre></div>

<h3 id="demonstration-three-updating-parameters">Demonstration Three: Updating Parameters<a class="headerlink" href="#demonstration-three-updating-parameters" title="Permanent link">&para;</a></h3>
<p>We've shown how a pokemon is sampled with the contextualized univariate TS algorithm, but how are parameters updated when the chosen target is successful or not? In this demonstration we will focus on updating the parameters \(\theta\) and \(X\).</p>
<p>In the simple case, we update the beta parameters for the current region to reflect this result. However, we would like to also update the contextual weighting matrix</p>
<p>
<script type="math/tex; mode=display">
  X = \left \{
  \begin{aligned}
    &X+(r_t-X)\space\eta, && \text{if}\ \theta_{max}=(\theta^T \cdot X)_{max} \\
    &X, && \text{otherwise}
  \end{aligned} \right.
</script>
</p>
<p>where $r_t$, the reward of the action taken, is $0$ when the target is incorrect and $1$ otherwise.</p>
<p>In this case, let's assume the answer chosen by the algorithm is <em>incorrect</em> so $r_t = 0$</p>
<p>First we check where in the samples the incorrectly selected pokemon is weighted highest</p>
<div class="codehilite"><pre><span></span><code><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>array([False,  True,  True,  True])
</code></pre></div>

<p>We turn this array of booleans into a region index</p>
<div class="codehilite"><pre><span></span><code><span class="n">to_reweight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)))</span>
<span class="c1"># we don&#39;t want to update the diagonal</span>
<span class="n">to_reweight</span> <span class="o">=</span> <span class="n">to_reweight</span><span class="p">[</span><span class="n">to_reweight</span> <span class="o">!=</span> <span class="n">region_id</span><span class="p">]</span>
<span class="n">to_reweight</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>array([1, 3])
</code></pre></div>

<p>We'll specify a learning weight</p>
<div class="codehilite"><pre><span></span><code><span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.2</span>
</code></pre></div>

<p>And update our coefficients</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># remove 10% of the difference between the current weight and 0</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Before&quot;</span><span class="p">)</span>
<span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
   <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
   <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;After&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(0.5, 1.0, &#39;After&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_63_1.png" /></p>
<p>We'll take the same process when we have a successful match, and reward the coefficients that helped us get that correct answer</p>
<p>
<script type="math/tex; mode=display">
  X = \left \{
  \begin{aligned}
    &X+(r_t-X)\space\alpha, && \text{if}\ \theta_{max}=\theta_{max}^T \cdot X \\
    &X, && \text{otherwise}
  \end{aligned} \right.
</script>
</p>
<p>where</p>
<p>
<script type="math/tex; mode=display">
r_t = 1
</script>
</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># the reward formula simplifies to</span>
<span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>array([0.1057324, 0.2      ])
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># add 10% of the difference between the current weight and 1</span>
<span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>array([0.57707039, 0.2       ])
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
<span class="c1"># SIM SETUP</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">lat_lng</span> <span class="o">=</span> <span class="n">get_city_center</span><span class="p">(</span><span class="s1">&#39;Pewter&#39;</span><span class="p">)</span>
<span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
<span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

<span class="n">ground_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pokemon_region_matrix</span><span class="o">/</span><span class="n">pokemon_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">region_region_matrix</span><span class="o">/</span><span class="n">region_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">before</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">pokemon_expectations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">)</span> <span class="c1"># an overall expected performance for each pokemon</span>
<span class="n">spatial_pokemon_expectations</span> <span class="o">=</span> <span class="n">ground_coef_matrix</span> <span class="o">*</span> <span class="n">pokemon_expectations</span>
<span class="n">dists</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">spatial_pokemon_expectations</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">num_searches</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">))</span>
<span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="c1"># params represents the success (alpha) and failure (beta)</span>
<span class="c1"># of finding each pokemon based on historical performances</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">init_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">regret</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">sim_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_searches</span><span class="p">):</span>

    <span class="c1">### SIMULATE SINGLE PATIENT BASED FLOW REQUEST ###</span>
    <span class="n">region_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_regions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pokemon_id</span> <span class="o">=</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">sim_step</span><span class="p">,</span> <span class="n">region_id</span><span class="p">]</span>

    <span class="c1"># load coefficients for the received region ID</span>
    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># sample from entire parameter matrix for surrounding area</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="c1"># calculate the mean of the distributions to determine regret</span>
    <span class="n">current_dist</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">max_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

    <span class="c1"># take the argmax of the weighted average for each pokemon</span>
    <span class="n">selected_pokemon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">selected_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> 

    <span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_pokemon</span><span class="p">)</span>
    <span class="n">regret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_exp</span> <span class="o">-</span> <span class="n">max_exp</span><span class="p">)</span>

    <span class="n">to_reweight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">selected_pokemon</span><span class="p">)</span>
    <span class="n">to_reweight</span> <span class="o">=</span> <span class="n">to_reweight</span><span class="p">[</span><span class="n">to_reweight</span> <span class="o">!=</span> <span class="n">region_id</span><span class="p">]</span>
    <span class="c1">### TRACK SUCCESS/FAIL UPDATE PARAMS ###</span>
    <span class="k">if</span> <span class="n">pokemon_id</span> <span class="o">==</span> <span class="n">selected_pokemon</span><span class="p">:</span>
        <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">+</span> \
           <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">+</span> \
           <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_pokemon</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
           <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
           <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_pokemon</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The sample shape is determined by (regions x pokemon): </span><span class="si">{</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="si">}</span><span class="se">\n</span><span class="s2">and reflects &quot;</span>\
     <span class="s2">&quot;the expected value for every pokemon for every region:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\theta$ (Sampled Expectations)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/pokemon1.png&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The contextual TS algorithm will sum these samples along axis 0 (regions) </span><span class="se">\n</span><span class="s2">weighted by the &quot;</span>\
      <span class="s2">&quot;distance to the selected region:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X$ (Context Coefficients, Start)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$X$ (Context Coefficients, End)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/pokemon2.png&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Every simulation round, a region is selected from which our algorithm receives a search request.&quot;</span><span class="p">)</span>
<span class="n">region_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_regions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The selected region for this round is: </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;and so the coefficients will reflect that we weight region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2"> by 1 and all other&quot;</span>\
     <span class="sa">f</span><span class="s2">&quot; regions between 0-1 </span><span class="se">\n</span><span class="s2">according to their distance to region </span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;so the final expected value matrix is:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Weighted Expectations&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/pokemon3.png&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;and pokemon </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="p">))</span><span class="si">}</span><span class="s2"> is selected this round&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>The sample shape is determined by (regions x pokemon): (4, 3)
and reflects the expected value for every pokemon for every region:
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_67_1.png" /></p>
<div class="codehilite"><pre><span></span><code>The contextual TS algorithm will sum these samples along axis 0 (regions) 
weighted by the distance to the selected region:
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_67_3.png" /></p>
<div class="codehilite"><pre><span></span><code>Every simulation round, a region is selected from which our algorithm receives a search request.
The selected region for this round is: 3
and so the coefficients will reflect that we weight region 3 by 1 and all other regions between 0-1 
according to their distance to region 3:

[0.42957413 0.56116383 0.49474465 1.        ]

so the final expected value matrix is:

[0.44658981 0.75022983 1.29657116]
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_67_5.png" /></p>
<div class="codehilite"><pre><span></span><code>and pokemon 2 is selected this round
</code></pre></div>

<p>We have this notion of regret in TS that is the difference between the expected value of the action taken by the algorithm and the maximum expected value the algorithm COULD have taken</p>
<div class="codehilite"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">regret</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>[&lt;matplotlib.lines.Line2D at 0x2abd4e2b0&gt;]
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_69_1.png" /></p>
<p>We can also look at the learned beta distributions of our algorithm</p>
<div class="codehilite"><pre><span></span><code><span class="n">est_pokemon_expectations</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">reweighted_est_pokemon_expectations</span> <span class="o">=</span> <span class="p">(</span><span class="n">est_pokemon_expectations</span> <span class="o">/</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">est_pokemon_expectations</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">num_pokemon</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">reweighted_est_pokemon_expectations</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;pokemon region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot; region&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(33.0, 0.5, &#39; region&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_71_1.png" /></p>
<p>We can compare this "learned" feature space with the ground truth</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># reweight so that each region sums to 1</span>
<span class="n">reweighted_spatial_pokemon_expectations</span> <span class="o">=</span> <span class="p">(</span><span class="n">spatial_pokemon_expectations</span> <span class="o">/</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">spatial_pokemon_expectations</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">num_pokemon</span><span class="p">)</span>
    <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">reweighted_spatial_pokemon_expectations</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;pokemon region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;region&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Text(33.0, 0.5, &#39;region&#39;)
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_73_1.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successes: </span><span class="si">{</span><span class="n">params</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">params</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failures: </span><span class="si">{</span><span class="n">params</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">params</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>successes: 49.8%
failures: 50.2%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;success from random guessing: </span><span class="si">{</span><span class="mi">1</span><span class="o">/</span><span class="n">num_pokemon</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code>success from random guessing: 33.3%
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">regret_ts_context</span> <span class="o">=</span> <span class="n">regret</span>
<span class="n">successes_ts_context</span> <span class="o">=</span> <span class="n">successes</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">moving_average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">regret</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">moving_average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">successes</span><span class="p">),</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">reweighted_est_pokemon_expectations</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">reweighted_spatial_pokemon_expectations</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Regret&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Success&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Learned Mean Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Starting Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ending Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Success Rate&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Delta Best vs Taken Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Pokemon&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;figures/pokemon4.png&quot;</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_77_0.png" /></p>
<h2 id="multiarmedbandit">MultiArmedBandit<a class="headerlink" href="#multiarmedbandit" title="Permanent link">&para;</a></h2>
<p>We can demonstrate now how we leverage this context in a search. Let's create the main class.</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MultiArmedBandit</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">num_targets</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                 <span class="n">num_regions</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_targets</span> <span class="o">=</span> <span class="n">num_targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span> <span class="o">=</span> <span class="n">num_regions</span>

    <span class="k">def</span> <span class="nf">make_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                   <span class="n">region_target_matrix</span><span class="p">,</span>
                   <span class="n">region_region_matrix</span><span class="p">,</span>
                   <span class="n">distance_strength</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">starting_context_scale</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">noise</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                   <span class="n">norm_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">num_retrievals</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                   <span class="n">learned_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">true_charts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        starting_context_scale ranges -1, 1. 0: standard linear distance weighting, 1: all coefs are 1</span>
<span class="sd">        -1: all coeffs are 0. </span>
<span class="sd">        # noise = 1 # should be randomized vector if not 1, will &quot;blur&quot; site_expectations</span>
<span class="sd">        num_retrievals = 100000 # the number of retrievals per postal code</span>
<span class="sd">        larger norm scale will give more equal weighting between sites</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_target_matrix</span> <span class="o">=</span> <span class="n">region_target_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">region_region_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_retrievals</span> <span class="o">=</span> <span class="n">num_retrievals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_scale</span> <span class="o">=</span> <span class="n">norm_scale</span>

        <span class="k">if</span> <span class="n">seed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">num_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_targets</span>
        <span class="n">num_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span>

        <span class="c1"># used for weighting of nearyby region samples</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">region_region_matrix</span> <span class="o">/</span> <span class="p">(</span><span class="n">region_region_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">starting_context_scale</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">adjust</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">starting_context_scale</span>
        <span class="k">elif</span> <span class="n">starting_context_scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">adjust</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">*</span> <span class="n">starting_context_scale</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">frac</span> <span class="o">+</span> <span class="n">adjust</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>

        <span class="c1"># we set the ground truth</span>
        <span class="k">if</span> <span class="n">true_charts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># an overall expected performance for each site</span>
            <span class="n">site_expectations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num_targets</span><span class="p">)</span> 
            <span class="n">ground_coef_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">region_target_matrix</span><span class="o">/</span><span class="n">region_target_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> 
                                               <span class="o">*</span> <span class="n">distance_strength</span><span class="p">))</span>
            <span class="n">spatial_target_expectations</span> <span class="o">=</span> <span class="n">ground_coef_matrix</span> <span class="o">*</span> <span class="n">site_expectations</span> <span class="o">*</span> <span class="n">noise</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">spatial_target_expectations</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">norm_scale</span><span class="p">)</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">dists</span><span class="o">.</span><span class="n">rvs</span><span class="p">((</span><span class="n">num_retrievals</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">))</span>
            <span class="n">true_charts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


            <span class="n">true_probs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_regions</span><span class="p">):</span>
                <span class="n">pop_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">true_charts</span><span class="p">[:,</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
                <span class="n">exp</span> <span class="o">=</span> <span class="p">(</span><span class="n">true_charts</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pop_site</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">true_charts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">true_probs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

            <span class="n">true_charts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span><span class="o">.</span><span class="n">melt</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:</span><span class="n">num_retrievals</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">spatial_target_expectations</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">true_charts</span><span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>\
                <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
            <span class="n">spatial_target_expectations</span> <span class="o">=</span> <span class="n">spatial_target_expectations</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">true_probs</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spatial_target_expectations</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">spatial_target_expectations</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_target_expectations</span> <span class="o">=</span> <span class="n">spatial_target_expectations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_probs</span> <span class="o">=</span> <span class="n">true_probs</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="n">context_coef_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_context</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">true_charts</span> <span class="o">=</span> <span class="n">true_charts</span>

        <span class="k">if</span> <span class="n">learned_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learned_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">num_targets</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learned_params</span> <span class="o">=</span> <span class="n">learned_params</span>

    <span class="k">def</span> <span class="nf">run_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">with_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">distance_heuristic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>

        <span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
        <span class="n">num_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span>
        <span class="n">num_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_targets</span>
        <span class="n">num_retrievals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_retrievals</span>
        <span class="n">true_charts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">true_charts</span>
        <span class="n">context_coef_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_coef_matrix</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learned_params</span>

        <span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">regret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">sim_step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_retrievals</span><span class="p">):</span>

            <span class="c1">### SIMULATE SINGLE PATIENT BASED FLOW REQUEST ###</span>
            <span class="n">region_id</span> <span class="o">=</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">sim_step</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">target_id</span> <span class="o">=</span> <span class="n">true_charts</span><span class="p">[</span><span class="n">sim_step</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="c1"># load coefficients for the received postal ID</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">region_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># sample from entire parameter matrix for surrounding area</span>
            <span class="k">if</span> <span class="n">with_context</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">selected_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">selected_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span> 

                <span class="c1"># calculate max exp</span>
                <span class="n">current_dist</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">max_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">coeffs</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>

                <span class="n">to_reweight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">selected_site</span><span class="p">)</span>
                <span class="c1"># do not update the diagonal</span>
                <span class="n">to_reweight</span> <span class="o">=</span> <span class="n">to_reweight</span><span class="p">[</span><span class="n">to_reweight</span> <span class="o">!=</span> <span class="n">region_id</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>  
                <span class="n">current_dist</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>

                <span class="c1"># not based on sampling, based on distance, but uses beta means for regret comparison</span>
                <span class="k">if</span> <span class="n">distance_heuristic</span><span class="p">:</span>
                    <span class="n">selected_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region_target_matrix</span><span class="p">[</span><span class="n">region_id</span><span class="p">])</span> 
                    <span class="n">selected_exp</span> <span class="o">=</span> <span class="n">current_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">selected_site</span><span class="p">]</span> 

                <span class="c1"># otherwise we do a non context TS selection</span>
                <span class="k">else</span><span class="p">:</span>         
                    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">selected_site</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
                    <span class="n">selected_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

                <span class="n">max_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">current_dist</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

            <span class="n">answer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selected_site</span><span class="p">)</span>
            <span class="n">regret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_exp</span> <span class="o">-</span> <span class="n">selected_exp</span><span class="p">)</span>

            <span class="c1">### TRACK SUCCESS/FAIL UPDATE PARAMS ###</span>
            <span class="k">if</span> <span class="n">target_id</span> <span class="o">==</span> <span class="n">selected_site</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">with_context</span><span class="p">:</span>
                    <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">+</span> \
                       <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">])</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_site</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">with_context</span><span class="p">:</span>
                    <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">region_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
                       <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="o">/</span><span class="n">num_targets</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">context_coef_matrix</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">to_reweight</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> \
                       <span class="p">((</span><span class="n">coeffs</span><span class="p">[</span><span class="n">to_reweight</span><span class="p">]</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">learning_rate</span><span class="o">/</span><span class="n">num_targets</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="n">region_id</span><span class="p">,</span> <span class="n">selected_site</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">regret</span> <span class="o">=</span> <span class="n">regret</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">successes</span> <span class="o">=</span> <span class="n">successes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learned_params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolling_success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">(</span><span class="n">successes</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_retrievals</span><span class="o">/</span><span class="mi">20</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rolling_regret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">moving_average</span><span class="p">(</span><span class="n">regret</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_retrievals</span><span class="o">/</span><span class="mi">20</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">show_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">num_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_targets</span>
        <span class="n">num_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span>

        <span class="c1"># fig, ax = plt.subplots(figsize=(5,5))</span>

        <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;ground&#39;</span><span class="p">:</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_target_expectations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># ax.set_xlabel(&quot;site postal code&quot;)</span>
            <span class="c1"># ax.set_ylabel(&quot;patient postal code&quot;)</span>

        <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;learned&#39;</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learned_params</span>
            <span class="n">est_target_expectations</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">reweighted_est_target_expectations</span> <span class="o">=</span> <span class="p">(</span><span class="n">est_target_expectations</span> <span class="o">/</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">est_target_expectations</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">num_targets</span><span class="p">)</span>
                <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_targets</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">reweighted_est_target_expectations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># ax.set_xlabel(&quot;site postal code&quot;)</span>
            <span class="c1"># ax.set_ylabel(&quot;patient postal code&quot;)</span>

        <span class="c1"># return fig</span>

    <span class="k">def</span> <span class="nf">moving_average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">w</span>
</code></pre></div>

<h3 id="pewter-city-sims">Pewter City Sims<a class="headerlink" href="#pewter-city-sims" title="Permanent link">&para;</a></h3>
<p>We can now after packaging our code, compare contextualized and non contextualized TS methods with a variety of hyperparameter settings</p>
<div class="codehilite"><pre><span></span><code><span class="c1">### SETUP THE GROUND TRUTH PARAMETER ###</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">30000</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
<span class="n">starting_context_scale</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span>


<span class="n">lat_lng</span> <span class="o">=</span> <span class="n">get_city_center</span><span class="p">(</span><span class="s1">&#39;Pewter&#39;</span><span class="p">)</span>
<span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
<span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

<span class="c1"># run w/o context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model1</span> <span class="o">=</span> <span class="n">model</span>

<span class="c1"># run with context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model2</span> <span class="o">=</span> <span class="n">model</span>

<span class="c1"># run w/o context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">distance_heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model3</span> <span class="o">=</span> <span class="n">model</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;without context&quot;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;with context&quot;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;distance heuristic&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:grey&#39;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:grey&#39;</span><span class="p">)</span>

<span class="n">model2</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;learned&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">model2</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">original_context</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Regret&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Success&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Learned Mean Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Starting Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ending Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Success Rate&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Delta Best vs Taken Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Site (Clinic)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Site (Clinic)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_82_0.png" /></p>
<div class="codehilite"><pre><span></span><code><span class="c1">### SETUP THE GROUND TRUTH PARAMETER ###</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">single_site_dominance</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
<span class="n">starting_context_scale</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span>


<span class="n">lat_lng</span> <span class="o">=</span> <span class="n">get_city_center</span><span class="p">(</span><span class="s1">&#39;Pewter&#39;</span><span class="p">)</span>
<span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
<span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

<span class="c1"># run w/o context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model1</span> <span class="o">=</span> <span class="n">model</span>

<span class="c1"># run with context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model2</span> <span class="o">=</span> <span class="n">model</span>

<span class="c1"># run w/o context</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                         <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">starting_context_scale</span><span class="o">=</span><span class="n">starting_context_scale</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">distance_heuristic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model3</span> <span class="o">=</span> <span class="n">model</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;without context&quot;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model1</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;with context&quot;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">rolling_regret</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;distance heuristic&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:grey&#39;</span><span class="p">)</span>
<span class="n">tot_success</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">successes</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model3</span><span class="o">.</span><span class="n">rolling_success</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tot_success</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:grey&#39;</span><span class="p">)</span>

<span class="n">model2</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;learned&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">model2</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">original_context</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">model2</span><span class="o">.</span><span class="n">context_coef_matrix</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Regret&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rolling Avg. Success&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Learned Mean Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True Expected Values&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Starting Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Ending Context Coefficients&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Success Rate&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time Step&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Delta Best vs Taken Reward&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Site (Clinic)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Site (Clinic)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Patient Postal&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_84_0.png" /></p>
<h3 id="confidence-intervals">Confidence Intervals<a class="headerlink" href="#confidence-intervals" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># SIM SETUP</span>
<span class="n">rounds</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1">### SETUP THE GROUND TRUTH PARAMETER ###</span>
<span class="n">num_pokemon</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_regions</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">num_searches</span> <span class="o">=</span> <span class="mi">3000</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">single_site_dominance</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1">### SETUP THE SIMULATION PARAMETERS ###</span>
<span class="n">starting_context_scale</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># RUN SIM</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rounds</span><span class="p">):</span>

    <span class="n">lat_lng_max</span> <span class="o">=</span> <span class="n">get_max_lng_lat</span><span class="p">(</span><span class="n">lat_lng</span><span class="p">,</span> <span class="n">km_max</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">pokemon</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">)</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">get_distance_matrix</span><span class="p">(</span><span class="n">lat_lng_max</span><span class="p">,</span> <span class="n">num_targets</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

    <span class="c1"># ground truth</span>
    <span class="n">region_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>
    <span class="n">pokemon_region_matrix</span> <span class="o">=</span> <span class="n">haversine_vectorized</span><span class="p">(</span><span class="n">pokemon</span><span class="p">,</span> <span class="n">regions</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">MultiArmedBandit</span><span class="p">(</span><span class="n">num_targets</span><span class="o">=</span><span class="n">num_pokemon</span><span class="p">,</span>
                             <span class="n">num_regions</span><span class="o">=</span><span class="n">num_regions</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">make_truth</span><span class="p">(</span><span class="n">pokemon_region_matrix</span><span class="p">,</span>
                 <span class="n">region_region_matrix</span><span class="p">,</span>
                 <span class="n">norm_scale</span><span class="o">=</span><span class="n">single_site_dominance</span><span class="p">,</span> 
                 <span class="n">num_retrievals</span><span class="o">=</span><span class="n">num_searches</span><span class="p">,</span>
                 <span class="n">distance_strength</span><span class="o">=</span><span class="n">distance_strength</span><span class="p">)</span>

    <span class="c1"># run w/o context</span>
    <span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">regret_ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rolling_regret</span>
    <span class="n">success_ts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rolling_success</span>

    <span class="c1"># run with context</span>
    <span class="n">model</span><span class="o">.</span><span class="n">run_ts</span><span class="p">(</span><span class="n">with_context</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">regret_ts_context</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rolling_regret</span>
    <span class="n">success_ts_context</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rolling_success</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">regrets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">regret_ts</span><span class="p">,</span> <span class="n">regret_ts_context</span><span class="p">])</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">success_ts</span><span class="p">,</span> <span class="n">success_ts_context</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">regrets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">regrets</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">regret_ts</span><span class="p">,</span> <span class="n">regret_ts_context</span><span class="p">])))</span>
        <span class="n">successes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">successes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">success_ts</span><span class="p">,</span> <span class="n">success_ts_context</span><span class="p">])))</span>
<span class="n">successes</span> <span class="o">=</span> <span class="n">successes</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rounds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">regrets</span> <span class="o">=</span> <span class="n">regrets</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">rounds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># i = 0 w/o context</span>
<span class="c1"># i = 1 w/ context</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;learned&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">show_heatmap</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s1">&#39;ground&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">over_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">97.5</span><span class="p">)</span>
    <span class="n">under_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="mi">1000</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">under_line</span><span class="p">,</span>
                      <span class="n">over_line</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Performance First 1000 Steps&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">over_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">97.5</span><span class="p">)</span>
    <span class="n">under_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> +/- </span><span class="si">{</span><span class="n">successes</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">under_line</span><span class="p">,</span>
                      <span class="n">over_line</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Performance All </span><span class="si">{</span><span class="n">num_searches</span><span class="si">}</span><span class="s2"> Steps&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Learned Mean Expected Values (with Context)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;True Expected Values&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># fig.savefig(&quot;figures/pewter2.png&quot;)</span>
</code></pre></div>

<p><img alt="png" src="../thompson_sampling_univariate_files/thompson_sampling_univariate_87_0.png" /></p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../vectorized_distances/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Vectorized Distance Calculations" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Vectorized Distance Calculations
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
  </body>
</html>